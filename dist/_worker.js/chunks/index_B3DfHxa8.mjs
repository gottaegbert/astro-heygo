globalThis.process??={},globalThis.process.env??={};import{d as distExports}from"./index_B7Oa2Wn_.mjs";import{H as decryptString,I as createSlotValueFromString,J as isAstroComponentFactory,d as renderComponent,a as renderTemplate,A as AstroError,K as ResponseSentError,O as originPathnameSymbol,P as RewriteWithBodyUsed,Q as MiddlewareNoDataOrNextCalled,S as MiddlewareNotAResponse,T as GetStaticPathsRequired,U as InvalidGetStaticPathsReturn,V as InvalidGetStaticPathsEntry,W as GetStaticPathsExpectedParams,X as GetStaticPathsInvalidRouteParam,Y as PageNumberParamNotFound,D as DEFAULT_404_COMPONENT,Z as NoMatchingStaticPathFound,$ as PrerenderDynamicEndpointPathCollide,a0 as ReservedSlotName,a1 as renderSlotToString,C as renderJSX,a2 as chunkToString,a3 as isRenderInstruction,a4 as SessionStorageSaveError,a5 as SessionStorageInitError,n as ROUTE_TYPE_HEADER,a6 as ForbiddenRewrite,a7 as ASTRO_VERSION,a8 as green,a9 as LocalsReassigned,aa as PrerenderClientAddressNotAvailable,w as clientAddressSymbol,ab as ClientAddressNotAvailable,ac as StaticClientAddressNotAvailable,ad as AstroResponseHeadersReassigned,z as responseSentSymbol$1,ae as renderPage,R as REROUTE_DIRECTIVE_HEADER,af as REWRITE_DIRECTIVE_HEADER_KEY,ag as REWRITE_DIRECTIVE_HEADER_VALUE,ah as renderEndpoint}from"./astro/server_8e5-x8mo.mjs";import{s as shouldAppendForwardSlash,d as computeCurrentLocale,e as computePreferredLocale,f as computePreferredLocaleList}from"./utils_BqL4Ztsg.mjs";import{r as removeTrailingForwardSlash,a as appendForwardSlash,p as prependForwardSlash,j as joinPaths,t as trimSlashes}from"./internal_q0A1Q6b1.mjs";import{g as getActionQueryString,a as deserializeActionResult,D as DEFAULT_404_ROUTE,A as ActionError,s as serializeActionResult,b as ACTION_RPC_ROUTE_PATTERN,c as ACTION_QUERY_PARAMS,f as stringify$2}from"./astro-designed-error-pages_3x6ndnTZ.mjs";import{u as unflatten$1}from"./parse_EttCPxrw.mjs";const ACTION_API_CONTEXT_SYMBOL=Symbol.for("astro.actionAPIContext"),formContentTypes=["application/x-www-form-urlencoded","multipart/form-data"];function hasContentType(e,t){const r=e.split(";")[0].toLowerCase();return t.some((e=>r===e))}function hasActionPayload(e){return"_actionPayload"in e}function createGetActionResult(e){return t=>{if(hasActionPayload(e)&&t.toString()===getActionQueryString(e._actionPayload.actionName))return deserializeActionResult(e._actionPayload.actionResult)}}function createCallAction(e){return(t,r)=>{Reflect.set(e,ACTION_API_CONTEXT_SYMBOL,!0);return t.bind(e)(r)}}function redirectIsExternal(e){return"string"==typeof e?e.startsWith("http://")||e.startsWith("https://"):e.destination.startsWith("http://")||e.destination.startsWith("https://")}async function renderRedirect(e){const{request:{method:t},routeData:r}=e,{redirect:s,redirectRoute:a}=r,n=a&&"object"==typeof s?s.status:"GET"===t?301:308,o={location:encodeURI(redirectRouteGenerate(e))};return s&&redirectIsExternal(s)?"string"==typeof s?Response.redirect(s,n):Response.redirect(s.destination,n):new Response(null,{status:n,headers:o})}function redirectRouteGenerate(e){const{params:t,routeData:{redirect:r,redirectRoute:s}}=e;if(void 0!==s)return s?.generate(t)||s?.pathname||"/";if("string"==typeof r){if(redirectIsExternal(r))return r;{let e=r;for(const r of Object.keys(t)){const s=t[r];e=e.replace(`[${r}]`,s).replace(`[...${r}]`,s)}return e}}return void 0===r?"/":r.destination}const SERVER_ISLAND_ROUTE="/_server-islands/[name]",SERVER_ISLAND_COMPONENT="_server-islands.astro",SERVER_ISLAND_BASE_PREFIX="_server-islands";function badRequest(e){return new Response(null,{status:400,statusText:"Bad request: "+e})}async function getRequestData(e){switch(e.method){case"GET":{const t=new URL(e.url).searchParams;if(!t.has("s")||!t.has("e")||!t.has("p"))return badRequest("Missing required query parameters.");const r=t.get("s");try{return{componentExport:t.get("e"),encryptedProps:t.get("p"),slots:JSON.parse(r)}}catch{return badRequest("Invalid slots format.")}}case"POST":try{const t=await e.text();return JSON.parse(t)}catch{return badRequest("Request format is invalid.")}default:return new Response(null,{status:405})}}function createEndpoint(e){const t=async t=>{const r=t.params;if(!r.name)return new Response(null,{status:400,statusText:"Bad request"});const s=r.name,a=await getRequestData(t.request);if(a instanceof Response)return a;const n=e.serverIslandMap?.get(s);if(!n)return new Response(null,{status:404,statusText:"Not found"});const o=await e.key,i=a.encryptedProps,c=""===i?"{}":await decryptString(o,i),u=JSON.parse(c);let l=(await n())[a.componentExport];const d={};for(const e in a.slots)d[e]=createSlotValueFromString(a.slots[e]);if(t.response.headers.set("X-Robots-Tag","noindex"),isAstroComponentFactory(l)){const e=l;l=function(...t){return e.apply(this,t)},Object.assign(l,e),l.propagation="self"}return renderTemplate`${renderComponent(t,"Component",l,u,d)}`};t.isAstroComponentFactory=!0;return{default:t,partial:!0}}function matchRoute(e,t){return t.routes.find((t=>t.pattern.test(e)||t.fallbackRoutes.some((t=>t.pattern.test(e)))))}const ROUTE404_RE=/^\/404\/?$/,ROUTE500_RE=/^\/500\/?$/;function isRoute404(e){return ROUTE404_RE.test(e)}function isRoute500(e){return ROUTE500_RE.test(e)}function isRoute404or500(e){return isRoute404(e.route)||isRoute500(e.route)}function isRouteServerIsland(e){return"_server-islands.astro"===e.component}function isRequestServerIsland(e,t=""){const r=new URL(e.url);return("/"===t?r.pathname.slice(t.length):r.pathname.slice(t.length+1)).startsWith("_server-islands")}function requestIs404Or500(e,t=""){const r=new URL(e.url).pathname.slice(t.length);return isRoute404(r)||isRoute500(r)}function isRouteExternalRedirect(e){return!("redirect"!==e.type||!e.redirect||!redirectIsExternal(e.redirect))}const DELETED_EXPIRATION=new Date(0),DELETED_VALUE="deleted",responseSentSymbol=Symbol.for("astro.responseSent"),identity=e=>e;class AstroCookie{constructor(e){this.value=e}json(){if(void 0===this.value)throw new Error("Cannot convert undefined to an object.");return JSON.parse(this.value)}number(){return Number(this.value)}boolean(){return"false"!==this.value&&("0"!==this.value&&Boolean(this.value))}}class AstroCookies{#e;#t;#r;#s;constructor(e){this.#e=e,this.#t=null,this.#r=null,this.#s=!1}delete(e,t){const{maxAge:r,expires:s,...a}=t||{},n={expires:DELETED_EXPIRATION,...a};this.#a().set(e,["deleted",distExports.serialize(e,"deleted",n),!1])}get(e,t=void 0){if(this.#r?.has(e)){let[t,,r]=this.#r.get(e);return r?new AstroCookie(t):void 0}const r=t?.decode??decodeURIComponent,s=this.#n();if(e in s){const t=s[e];if(t)return new AstroCookie(r(t))}}has(e,t){if(this.#r?.has(e)){let[,,t]=this.#r.get(e);return t}return void 0!==this.#n()[e]}set(e,t,r){if(this.#s){const e=new Error("Astro.cookies.set() was called after the cookies had already been sent to the browser.\nThis may have happened if this method was called in an imported component.\nPlease make sure that Astro.cookies.set() is only called in the frontmatter of the main page.");e.name="Warning",console.warn(e)}let s;if("string"==typeof t)s=t;else{let e=t.toString();s=e===Object.prototype.toString.call(t)?JSON.stringify(t):e}const a={};if(r&&Object.assign(a,r),this.#a().set(e,[s,distExports.serialize(e,s,a),!0]),this.#e[responseSentSymbol])throw new AstroError({...ResponseSentError})}merge(e){const t=e.#r;if(t)for(const[e,r]of t)this.#a().set(e,r)}*headers(){if(null!=this.#r)for(const[,e]of this.#r)yield e[1]}static consume(e){return e.#s=!0,e.headers()}#n(){return this.#t||this.#o(),this.#t||(this.#t={}),this.#t}#a(){return this.#r||(this.#r=new Map),this.#r}#o(){const e=this.#e.headers.get("cookie");e&&(this.#t=distExports.parse(e,{decode:identity}))}}const astroCookiesSymbol=Symbol.for("astro.cookies");function attachCookiesToResponse(e,t){Reflect.set(e,astroCookiesSymbol,t)}function getCookiesFromResponse(e){let t=Reflect.get(e,astroCookiesSymbol);return null!=t?t:void 0}function*getSetCookiesFromResponse(e){const t=getCookiesFromResponse(e);if(!t)return[];for(const e of AstroCookies.consume(t))yield e;return[]}function createRequest({url:e,headers:t,method:r="GET",body:s,logger:a,isPrerendered:n=!1,routePattern:o,init:i}){const c=n?void 0:t instanceof Headers?t:new Headers(Object.entries(t).filter((([e])=>!e.startsWith(":"))));"string"==typeof e&&(e=new URL(e)),n&&(e.search="");const u=new Request(e,{method:r,headers:c,body:n?null:s,...i});if(n){let e=u.headers;const{value:t,writable:r,...s}=Object.getOwnPropertyDescriptor(u,"headers")||{};Object.defineProperty(u,"headers",{...s,get:()=>(a.warn(null,`\`Astro.request.headers\` was used when rendering the route \`${o}'\`. \`Astro.request.headers\` is not available on prerendered pages. If you need access to request headers, make sure that the page is server-rendered using \`export const prerender = false;\` or by setting \`output\` to \`"server"\` in your Astro config to make all your pages server-rendered by default.`),e),set(t){e=t}})}return u}function findRouteToRewrite({payload:e,routes:t,request:r,trailingSlash:s,buildFormat:a,base:n}){let o;o=e instanceof URL?e:e instanceof Request?new URL(e.url):new URL(e,new URL(r.url).origin);let i=o.pathname;const c=shouldAppendForwardSlash(s,a);if("/"!==n){o.pathname===n||o.pathname===removeTrailingForwardSlash(n)?i=c?"/":"":o.pathname.startsWith(n)&&(i=c?appendForwardSlash(o.pathname):removeTrailingForwardSlash(o.pathname),i=i.slice(n.length))}!i.startsWith("/")&&c&&o.pathname.endsWith("/")&&(i=prependForwardSlash(i)),"/"!==i||"/"===n||c||(i=""),o.pathname="/"===n||""!==i&&"/"!==i||c?joinPaths(...[n,i].filter(Boolean)):removeTrailingForwardSlash(n);const u=decodeURI(i);let l;for(const e of t)if(e.pattern.test(u)){l=e;break}if(l)return{routeData:l,newUrl:o,pathname:u};{const e=t.find((e=>"/404"===e.route));return e?{routeData:e,newUrl:o,pathname:i}:{routeData:DEFAULT_404_ROUTE,newUrl:o,pathname:i}}}function copyRequest(e,t,r,s,a){if(t.bodyUsed)throw new AstroError(RewriteWithBodyUsed);return createRequest({url:e,method:t.method,body:t.body,isPrerendered:r,logger:s,headers:r?{}:t.headers,routePattern:a,init:{referrer:t.referrer,referrerPolicy:t.referrerPolicy,mode:t.mode,credentials:t.credentials,cache:t.cache,redirect:t.redirect,integrity:t.integrity,signal:t.signal,keepalive:t.keepalive,duplex:"half"}})}function setOriginPathname(e,t){Reflect.set(e,originPathnameSymbol,encodeURIComponent(t))}function getOriginPathname(e){const t=Reflect.get(e,originPathnameSymbol);return t?decodeURIComponent(t):new URL(e.url).pathname}function getActionContext(e){const t=getCallerInfo(e),r=Boolean(e.locals._actionPayload);let s;return t&&"POST"===e.request.method&&!r&&(s={calledFrom:t.from,name:t.name,handler:async()=>{const r=Reflect.get(e,apiContextRoutesSymbol),s=shouldAppendForwardSlash(r.manifest.trailingSlash,r.manifest.buildFormat)?removeTrailingForwardSlash(t.name):t.name,a=await r.getAction(s);let n;try{n=await parseRequestBody(e.request)}catch(e){if(e instanceof TypeError)return{data:void 0,error:new ActionError({code:"UNSUPPORTED_MEDIA_TYPE"})};throw e}const o=["props","getActionResult","callAction","redirect"],i=Object.create(Object.getPrototypeOf(e),Object.fromEntries(Object.entries(Object.getOwnPropertyDescriptors(e)).filter((([e])=>!o.includes(e)))));Reflect.set(i,ACTION_API_CONTEXT_SYMBOL,!0);return a.bind(i)(n)}}),{action:s,setActionResult:function(t,r){e.locals._actionPayload={actionResult:r,actionName:t}},serializeActionResult:serializeActionResult,deserializeActionResult:deserializeActionResult}}function getCallerInfo(e){if(e.routePattern===ACTION_RPC_ROUTE_PATTERN)return{from:"rpc",name:e.url.pathname.replace(/^.*\/_actions\//,"")};const t=e.url.searchParams.get(ACTION_QUERY_PARAMS.actionName);return t?{from:"form",name:t}:void 0}async function parseRequestBody(e){const t=e.headers.get("content-type"),r=e.headers.get("Content-Length");if(t){if(hasContentType(t,formContentTypes))return await e.clone().formData();if(hasContentType(t,["application/json"]))return"0"===r?void 0:await e.clone().json();throw new TypeError("Unsupported content type")}}async function callMiddleware(e,t,r){let s,a=!1;let n=e(t,(async e=>(a=!0,s=r(t,e),s)));return await Promise.resolve(n).then((async e=>{if(a){if(void 0!==e){if(e instanceof Response==!1)throw new AstroError(MiddlewareNotAResponse);return e}if(s)return s;throw new AstroError(MiddlewareNotAResponse)}if(void 0===e)throw new AstroError(MiddlewareNoDataOrNextCalled);if(e instanceof Response==!1)throw new AstroError(MiddlewareNotAResponse);return e}))}const VALID_PARAM_TYPES=["string","number","undefined"];function validateGetStaticPathsParameter([e,t],r){if(!VALID_PARAM_TYPES.includes(typeof t))throw new AstroError({...GetStaticPathsInvalidRouteParam,message:GetStaticPathsInvalidRouteParam.message(e,t,typeof t),location:{file:r}})}function validateDynamicRouteModule(e,{ssr:t,route:r}){if((!t||r.prerender)&&!e.getStaticPaths)throw new AstroError({...GetStaticPathsRequired,location:{file:r.component}})}function validateGetStaticPathsResult(e,t,r){if(!Array.isArray(e))throw new AstroError({...InvalidGetStaticPathsReturn,message:InvalidGetStaticPathsReturn.message(typeof e),location:{file:r.component}});e.forEach((e=>{if("object"==typeof e&&Array.isArray(e)||null===e)throw new AstroError({...InvalidGetStaticPathsEntry,message:InvalidGetStaticPathsEntry.message(Array.isArray(e)?"array":typeof e)});if(void 0===e.params||null===e.params||e.params&&0===Object.keys(e.params).length)throw new AstroError({...GetStaticPathsExpectedParams,location:{file:r.component}});for(const[r,s]of Object.entries(e.params))void 0!==s&&"string"!=typeof s&&"number"!=typeof s&&t.warn("router",`getStaticPaths() returned an invalid path param: "${r}". A string, number or undefined value was expected, but got \`${JSON.stringify(s)}\`.`),"string"==typeof s&&""===s&&t.warn("router",`getStaticPaths() returned an invalid path param: "${r}". \`undefined\` expected for an optional param, but got empty string.`)}))}function stringifyParams(e,t){const r=Object.entries(e).reduce(((e,r)=>{validateGetStaticPathsParameter(r,t.component);const[s,a]=r;return void 0!==a&&(e[s]="string"==typeof a?trimSlashes(a):a.toString()),e}),{});return t.generate(r)}function generatePaginateFunction(e,t){return function(r,s={}){let{pageSize:a,params:n,props:o}=s;const i=a||10,c="page",u=n||{},l=o||{};let d;if(e.params.includes(`...${c}`))d=!1;else{if(!e.params.includes(`${c}`))throw new AstroError({...PageNumberParamNotFound,message:PageNumberParamNotFound.message(c)});d=!0}const h=Math.max(1,Math.ceil(r.length/i));return[...Array(h).keys()].map((s=>{const a=s+1,n=i===1/0?0:(a-1)*i,o=Math.min(n+i,r.length),g={...u,[c]:d||a>1?String(a):void 0},p=addRouteBase(e.generate({...g}),t),m=a===h?void 0:addRouteBase(e.generate({...g,page:String(a+1)}),t),f=1===a?void 0:addRouteBase(e.generate({...g,page:d||a-1!=1?String(a-1):void 0}),t),y=1===a?void 0:addRouteBase(e.generate({...g,page:d?"1":void 0}),t),w=a===h?void 0:addRouteBase(e.generate({...g,page:String(h)}),t);return{params:g,props:{...l,page:{data:r.slice(n,o),start:n,end:o-1,size:i,total:r.length,currentPage:a,lastPage:h,url:{current:p,next:m,prev:f,first:y,last:w}}}}}))}}function addRouteBase(e,t){let r=joinPaths(t,e);return""===r&&(r="/"),r}async function callGetStaticPaths({mod:e,route:t,routeCache:r,logger:s,ssr:a,base:n}){const o=r.get(t);if(!e)throw new Error("This is an error caused by Astro and not your code. Please file an issue.");if(o?.staticPaths)return o.staticPaths;if(validateDynamicRouteModule(e,{ssr:a,route:t}),a&&!t.prerender){const e=Object.assign([],{keyed:new Map});return r.set(t,{...o,staticPaths:e}),e}let i=[];if(!e.getStaticPaths)throw new Error("Unexpected Error.");i=await e.getStaticPaths({paginate:generatePaginateFunction(t,n)}),validateGetStaticPathsResult(i,s,t);const c=i;c.keyed=new Map;for(const e of c){const r=stringifyParams(e.params,t);c.keyed.set(r,e)}return r.set(t,{...o,staticPaths:c}),c}class RouteCache{logger;cache={};runtimeMode;constructor(e,t="production"){this.logger=e,this.runtimeMode=t}clearAll(){this.cache={}}set(e,t){const r=this.key(e);"production"===this.runtimeMode&&this.cache[r]?.staticPaths&&this.logger.warn(null,`Internal Warning: route cache overwritten. (${r})`),this.cache[r]=t}get(e){return this.cache[this.key(e)]}key(e){return`${e.route}_${e.component}`}}function findPathItemByKey(e,t,r,s){const a=stringifyParams(t,r),n=e.keyed.get(a);if(n)return n;s.debug("router",`findPathItemByKey() - Unexpected cache miss looking for ${a}`)}function routeIsRedirect(e){return"redirect"===e?.type}function routeIsFallback(e){return"fallback"===e?.type}async function getProps(e){const{logger:t,mod:r,routeData:s,routeCache:a,pathname:n,serverLike:o,base:i}=e;if(!s||s.pathname)return{};if(routeIsRedirect(s)||routeIsFallback(s)||s.component===DEFAULT_404_COMPONENT)return{};const c=await callGetStaticPaths({mod:r,route:s,routeCache:a,logger:t,ssr:o,base:i}),u=getParams(s,n),l=findPathItemByKey(c,u,s,t);if(!l&&(!o||s.prerender))throw new AstroError({...NoMatchingStaticPathFound,message:NoMatchingStaticPathFound.message(n),hint:NoMatchingStaticPathFound.hint([s.component])});r&&validatePrerenderEndpointCollision(s,r,u);return l?.props?{...l.props}:{}}function getParams(e,t){if(!e.params.length)return{};const r=e.pattern.exec(t)||e.fallbackRoutes.map((e=>e.pattern.exec(t))).find((e=>e));if(!r)return{};const s={};return e.params.forEach(((e,t)=>{e.startsWith("...")?s[e.slice(3)]=r[t+1]?r[t+1]:void 0:s[e]=r[t+1]})),s}function validatePrerenderEndpointCollision(e,t,r){if("endpoint"===e.type&&t.getStaticPaths){const t=e.segments[e.segments.length-1],s=Object.values(r),a=s[s.length-1];if(1===t.length&&t[0].dynamic&&void 0===a)throw new AstroError({...PrerenderDynamicEndpointPathCollide,message:PrerenderDynamicEndpointPathCollide.message(e.route),hint:PrerenderDynamicEndpointPathCollide.hint(e.component),location:{file:e.component}})}}function getFunctionExpression(e){if(!e)return;const t=e?.expressions?.filter((e=>!1===isRenderInstruction(e)));return 1===t?.length?t[0]:void 0}class Slots{#i;#c;#u;constructor(e,t,r){if(this.#i=e,this.#c=t,this.#u=r,t)for(const e of Object.keys(t)){if(void 0!==this[e])throw new AstroError({...ReservedSlotName,message:ReservedSlotName.message(e)});Object.defineProperty(this,e,{get:()=>!0,enumerable:!0})}}has(e){return!!this.#c&&Boolean(this.#c[e])}async render(e,t=[]){if(!this.#c||!this.has(e))return;const r=this.#i;if(Array.isArray(t)){if(t.length>0){const s=this.#c[e],a="function"==typeof s?await s(r):await s,n=getFunctionExpression(a);if(n){const e=async()=>"function"==typeof n?n(...t):n;return await renderSlotToString(r,e).then((e=>e))}if("function"==typeof a)return await renderJSX(r,a(...t)).then((e=>null!=e?String(e):e))}}else this.#u.warn(null,`Expected second parameter to be an array, received a ${typeof t}. If you're trying to pass an array as a single argument and getting unexpected results, make sure you're passing your array as a item of an array. Ex: Astro.slots.render('default', [["Hello", "World"]])`);const s=await renderSlotToString(r,this.#c[e]);return chunkToString(r,s)}}const suspectProtoRx=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,suspectConstructorRx=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,JsonSigRx=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function jsonParseTransform(e,t){if(!("__proto__"===e||"constructor"===e&&t&&"object"==typeof t&&"prototype"in t))return t;warnKeyDropped(e)}function warnKeyDropped(e){console.warn(`[destr] Dropping "${e}" key to prevent prototype pollution.`)}function destr(e,t={}){if("string"!=typeof e)return e;if('"'===e[0]&&'"'===e[e.length-1]&&-1===e.indexOf("\\"))return e.slice(1,-1);const r=e.trim();if(r.length<=9)switch(r.toLowerCase()){case"true":return!0;case"false":return!1;case"undefined":return;case"null":return null;case"nan":return Number.NaN;case"infinity":return Number.POSITIVE_INFINITY;case"-infinity":return Number.NEGATIVE_INFINITY}if(!JsonSigRx.test(e)){if(t.strict)throw new SyntaxError("[destr] Invalid JSON");return e}try{if(suspectProtoRx.test(e)||suspectConstructorRx.test(e)){if(t.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(e,jsonParseTransform)}return JSON.parse(e)}catch(r){if(t.strict)throw r;return e}}function wrapToPromise(e){return e&&"function"==typeof e.then?e:Promise.resolve(e)}function asyncCall(e,...t){try{return wrapToPromise(e(...t))}catch(e){return Promise.reject(e)}}function isPrimitive(e){const t=typeof e;return null===e||"object"!==t&&"function"!==t}function isPureObject(e){const t=Object.getPrototypeOf(e);return!t||t.isPrototypeOf(Object)}function stringify$1(e){if(isPrimitive(e))return String(e);if(isPureObject(e)||Array.isArray(e))return JSON.stringify(e);if("function"==typeof e.toJSON)return stringify$1(e.toJSON());throw new Error("[unstorage] Cannot stringify value!")}const BASE64_PREFIX="base64:";function serializeRaw(e){return"string"==typeof e?e:"base64:"+base64Encode(e)}function deserializeRaw(e){return"string"!=typeof e?e:e.startsWith("base64:")?base64Decode(e.slice(7)):e}function base64Decode(e){return globalThis.Buffer?Buffer.from(e,"base64"):Uint8Array.from(globalThis.atob(e),(e=>e.codePointAt(0)))}function base64Encode(e){return globalThis.Buffer?Buffer.from(e).toString("base64"):globalThis.btoa(String.fromCodePoint(...e))}function normalizeKey(e){return e&&e.split("?")[0]?.replace(/[/\\]/g,":").replace(/:+/g,":").replace(/^:|:$/g,"")||""}function joinKeys(...e){return normalizeKey(e.join(":"))}function normalizeBaseKey(e){return(e=normalizeKey(e))?e+":":""}function filterKeyByDepth(e,t){if(void 0===t)return!0;let r=0,s=e.indexOf(":");for(;s>-1;)r++,s=e.indexOf(":",s+1);return r<=t}function filterKeyByBase(e,t){return t?e.startsWith(t)&&"$"!==e[e.length-1]:"$"!==e[e.length-1]}function defineDriver(e){return e}const DRIVER_NAME="memory",memory=defineDriver((()=>{const e=new Map;return{name:"memory",getInstance:()=>e,hasItem:t=>e.has(t),getItem:t=>e.get(t)??null,getItemRaw:t=>e.get(t)??null,setItem(t,r){e.set(t,r)},setItemRaw(t,r){e.set(t,r)},removeItem(t){e.delete(t)},getKeys:()=>[...e.keys()],clear(){e.clear()},dispose(){e.clear()}}}));function createStorage(e={}){const t={mounts:{"":e.driver||memory()},mountpoints:[""],watching:!1,watchListeners:[],unwatch:{}},r=e=>{for(const r of t.mountpoints)if(e.startsWith(r))return{base:r,relativeKey:e.slice(r.length),driver:t.mounts[r]};return{base:"",relativeKey:e,driver:t.mounts[""]}},s=(e,r)=>t.mountpoints.filter((t=>t.startsWith(e)||r&&e.startsWith(t))).map((r=>({relativeBase:e.length>r.length?e.slice(r.length):void 0,mountpoint:r,driver:t.mounts[r]}))),a=(e,r)=>{if(t.watching){r=normalizeKey(r);for(const s of t.watchListeners)s(e,r)}},n=async()=>{if(t.watching){for(const e in t.unwatch)await t.unwatch[e]();t.unwatch={},t.watching=!1}},o=(e,t,s)=>{const a=new Map,n=e=>{let t=a.get(e.base);return t||(t={driver:e.driver,base:e.base,items:[]},a.set(e.base,t)),t};for(const s of e){const e="string"==typeof s,a=normalizeKey(e?s:s.key),o=e?void 0:s.value,i=e||!s.options?t:{...t,...s.options},c=r(a);n(c).items.push({key:a,value:o,relativeKey:c.relativeKey,options:i})}return Promise.all([...a.values()].map((e=>s(e)))).then((e=>e.flat()))},i={hasItem(e,t={}){e=normalizeKey(e);const{relativeKey:s,driver:a}=r(e);return asyncCall(a.hasItem,s,t)},getItem(e,t={}){e=normalizeKey(e);const{relativeKey:s,driver:a}=r(e);return asyncCall(a.getItem,s,t).then((e=>destr(e)))},getItems:(e,t={})=>o(e,t,(e=>e.driver.getItems?asyncCall(e.driver.getItems,e.items.map((e=>({key:e.relativeKey,options:e.options}))),t).then((t=>t.map((t=>({key:joinKeys(e.base,t.key),value:destr(t.value)}))))):Promise.all(e.items.map((t=>asyncCall(e.driver.getItem,t.relativeKey,t.options).then((e=>({key:t.key,value:destr(e)})))))))),getItemRaw(e,t={}){e=normalizeKey(e);const{relativeKey:s,driver:a}=r(e);return a.getItemRaw?asyncCall(a.getItemRaw,s,t):asyncCall(a.getItem,s,t).then((e=>deserializeRaw(e)))},async setItem(e,t,s={}){if(void 0===t)return i.removeItem(e);e=normalizeKey(e);const{relativeKey:n,driver:o}=r(e);o.setItem&&(await asyncCall(o.setItem,n,stringify$1(t),s),o.watch||a("update",e))},async setItems(e,t){await o(e,t,(async e=>{if(e.driver.setItems)return asyncCall(e.driver.setItems,e.items.map((e=>({key:e.relativeKey,value:stringify$1(e.value),options:e.options}))),t);e.driver.setItem&&await Promise.all(e.items.map((t=>asyncCall(e.driver.setItem,t.relativeKey,stringify$1(t.value),t.options))))}))},async setItemRaw(e,t,s={}){if(void 0===t)return i.removeItem(e,s);e=normalizeKey(e);const{relativeKey:n,driver:o}=r(e);if(o.setItemRaw)await asyncCall(o.setItemRaw,n,t,s);else{if(!o.setItem)return;await asyncCall(o.setItem,n,serializeRaw(t),s)}o.watch||a("update",e)},async removeItem(e,t={}){"boolean"==typeof t&&(t={removeMeta:t}),e=normalizeKey(e);const{relativeKey:s,driver:n}=r(e);n.removeItem&&(await asyncCall(n.removeItem,s,t),(t.removeMeta||t.removeMata)&&await asyncCall(n.removeItem,s+"$",t),n.watch||a("remove",e))},async getMeta(e,t={}){"boolean"==typeof t&&(t={nativeOnly:t}),e=normalizeKey(e);const{relativeKey:s,driver:a}=r(e),n=Object.create(null);if(a.getMeta&&Object.assign(n,await asyncCall(a.getMeta,s,t)),!t.nativeOnly){const e=await asyncCall(a.getItem,s+"$",t).then((e=>destr(e)));e&&"object"==typeof e&&("string"==typeof e.atime&&(e.atime=new Date(e.atime)),"string"==typeof e.mtime&&(e.mtime=new Date(e.mtime)),Object.assign(n,e))}return n},setMeta(e,t,r={}){return this.setItem(e+"$",t,r)},removeMeta(e,t={}){return this.removeItem(e+"$",t)},async getKeys(e,t={}){e=normalizeBaseKey(e);const r=s(e,!0);let a=[];const n=[];let o=!0;for(const e of r){e.driver.flags?.maxDepth||(o=!1);const r=await asyncCall(e.driver.getKeys,e.relativeBase,t);for(const t of r){const r=e.mountpoint+normalizeKey(t);a.some((e=>r.startsWith(e)))||n.push(r)}a=[e.mountpoint,...a.filter((t=>!t.startsWith(e.mountpoint)))]}const i=void 0!==t.maxDepth&&!o;return n.filter((r=>(!i||filterKeyByDepth(r,t.maxDepth))&&filterKeyByBase(r,e)))},async clear(e,t={}){e=normalizeBaseKey(e),await Promise.all(s(e,!1).map((async e=>{if(e.driver.clear)return asyncCall(e.driver.clear,e.relativeBase,t);if(e.driver.removeItem){const r=await e.driver.getKeys(e.relativeBase||"",t);return Promise.all(r.map((r=>e.driver.removeItem(r,t))))}})))},async dispose(){await Promise.all(Object.values(t.mounts).map((e=>dispose(e))))},watch:async e=>(await(async()=>{if(!t.watching){t.watching=!0;for(const e in t.mounts)t.unwatch[e]=await watch(t.mounts[e],a,e)}})(),t.watchListeners.push(e),async()=>{t.watchListeners=t.watchListeners.filter((t=>t!==e)),0===t.watchListeners.length&&await n()}),async unwatch(){t.watchListeners=[],await n()},mount(e,r){if((e=normalizeBaseKey(e))&&t.mounts[e])throw new Error(`already mounted at ${e}`);return e&&(t.mountpoints.push(e),t.mountpoints.sort(((e,t)=>t.length-e.length))),t.mounts[e]=r,t.watching&&Promise.resolve(watch(r,a,e)).then((r=>{t.unwatch[e]=r})).catch(console.error),i},async unmount(e,r=!0){(e=normalizeBaseKey(e))&&t.mounts[e]&&(t.watching&&e in t.unwatch&&(t.unwatch[e]?.(),delete t.unwatch[e]),r&&await dispose(t.mounts[e]),t.mountpoints=t.mountpoints.filter((t=>t!==e)),delete t.mounts[e])},getMount(e=""){e=normalizeKey(e)+":";const t=r(e);return{driver:t.driver,base:t.base}},getMounts(e="",t={}){e=normalizeKey(e);return s(e,t.parents).map((e=>({driver:e.driver,base:e.mountpoint})))},keys:(e,t={})=>i.getKeys(e,t),get:(e,t={})=>i.getItem(e,t),set:(e,t,r={})=>i.setItem(e,t,r),has:(e,t={})=>i.hasItem(e,t),del:(e,t={})=>i.removeItem(e,t),remove:(e,t={})=>i.removeItem(e,t)};return i}function watch(e,t,r){return e.watch?e.watch(((e,s)=>t(e,r+s))):()=>{}}async function dispose(e){"function"==typeof e.dispose&&await asyncCall(e.dispose)}const builtinDrivers={"azure-app-configuration":"unstorage/drivers/azure-app-configuration",azureAppConfiguration:"unstorage/drivers/azure-app-configuration","azure-cosmos":"unstorage/drivers/azure-cosmos",azureCosmos:"unstorage/drivers/azure-cosmos","azure-key-vault":"unstorage/drivers/azure-key-vault",azureKeyVault:"unstorage/drivers/azure-key-vault","azure-storage-blob":"unstorage/drivers/azure-storage-blob",azureStorageBlob:"unstorage/drivers/azure-storage-blob","azure-storage-table":"unstorage/drivers/azure-storage-table",azureStorageTable:"unstorage/drivers/azure-storage-table","capacitor-preferences":"unstorage/drivers/capacitor-preferences",capacitorPreferences:"unstorage/drivers/capacitor-preferences","cloudflare-kv-binding":"unstorage/drivers/cloudflare-kv-binding",cloudflareKVBinding:"unstorage/drivers/cloudflare-kv-binding","cloudflare-kv-http":"unstorage/drivers/cloudflare-kv-http",cloudflareKVHttp:"unstorage/drivers/cloudflare-kv-http","cloudflare-r2-binding":"unstorage/drivers/cloudflare-r2-binding",cloudflareR2Binding:"unstorage/drivers/cloudflare-r2-binding",db0:"unstorage/drivers/db0","deno-kv-node":"unstorage/drivers/deno-kv-node",denoKVNode:"unstorage/drivers/deno-kv-node","deno-kv":"unstorage/drivers/deno-kv",denoKV:"unstorage/drivers/deno-kv","fs-lite":"unstorage/drivers/fs-lite",fsLite:"unstorage/drivers/fs-lite",fs:"unstorage/drivers/fs",github:"unstorage/drivers/github",http:"unstorage/drivers/http",indexedb:"unstorage/drivers/indexedb",localstorage:"unstorage/drivers/localstorage","lru-cache":"unstorage/drivers/lru-cache",lruCache:"unstorage/drivers/lru-cache",memory:"unstorage/drivers/memory",mongodb:"unstorage/drivers/mongodb","netlify-blobs":"unstorage/drivers/netlify-blobs",netlifyBlobs:"unstorage/drivers/netlify-blobs",null:"unstorage/drivers/null",overlay:"unstorage/drivers/overlay",planetscale:"unstorage/drivers/planetscale",redis:"unstorage/drivers/redis",s3:"unstorage/drivers/s3","session-storage":"unstorage/drivers/session-storage",sessionStorage:"unstorage/drivers/session-storage",uploadthing:"unstorage/drivers/uploadthing",upstash:"unstorage/drivers/upstash","vercel-blob":"unstorage/drivers/vercel-blob",vercelBlob:"unstorage/drivers/vercel-blob","vercel-kv":"unstorage/drivers/vercel-kv",vercelKV:"unstorage/drivers/vercel-kv"},PERSIST_SYMBOL=Symbol(),DEFAULT_COOKIE_NAME="astro-session",VALID_COOKIE_REGEX=/^[\w-]+$/,unflatten=(e,t)=>unflatten$1(e,{URL:e=>new URL(e)}),stringify=(e,t)=>stringify$2(e,{URL:e=>e instanceof URL&&e.href});class AstroSession{#l;#d;#h;#g;#p;#m;#f;#y=new Set;#w=new Set;#v=!1;#R=!1;#E=!0;static#S=new Map;constructor(e,{cookie:t=DEFAULT_COOKIE_NAME,...r},s){let a;if(this.#l=e,"object"==typeof t){const{name:e=DEFAULT_COOKIE_NAME,...r}=t;this.#g=e,a=r}else this.#g=t||DEFAULT_COOKIE_NAME;this.#h={sameSite:"lax",secure:"production"===s,path:"/",...a,httpOnly:!0},this.#d=r}async get(e){return(await this.#b()).get(e)?.data}async has(e){return(await this.#b()).has(e)}async keys(){return(await this.#b()).keys()}async values(){return[...(await this.#b()).values()].map((e=>e.data))}async entries(){return[...(await this.#b()).entries()].map((([e,t])=>[e,t.data]))}delete(e){this.#m?.delete(e),this.#E&&this.#w.add(e),this.#v=!0}set(e,t,{ttl:r}={}){if(!e)throw new AstroError({...SessionStorageSaveError,message:"The session key was not provided."});let s;try{s=unflatten(JSON.parse(stringify(t)))}catch(t){throw new AstroError({...SessionStorageSaveError,message:`The session data for ${e} could not be serialized.`,hint:"See the devalue library for all supported types: https://github.com/rich-harris/devalue"},{cause:t})}this.#R||(this.#A(),this.#R=!0),this.#m??=new Map;const a=r??this.#d.ttl,n="number"==typeof a?Date.now()+1e3*a:a;this.#m.set(e,{data:s,expires:n}),this.#v=!0}destroy(){this.#P()}async regenerate(){let e=new Map;try{e=await this.#b()}catch(e){console.error("Failed to load session data during regeneration:",e)}const t=this.#f;this.#f=crypto.randomUUID(),this.#m=e,await this.#A(),t&&this.#p&&this.#p.removeItem(t).catch((e=>{console.error("Failed to remove old session data:",e)}))}async[PERSIST_SYMBOL](){if(!this.#v&&!this.#y.size)return;const e=await this.#I();if(this.#v&&this.#m){const t=await this.#b();this.#w.forEach((e=>t.delete(e)));const r=this.#C();let s;try{s=stringify(t)}catch(e){throw new AstroError({...SessionStorageSaveError,message:SessionStorageSaveError.message("The session data could not be serialized.",this.#d.driver)},{cause:e})}await e.setItem(r,s),this.#v=!1}if(this.#y.size>0){const t=[...this.#y].map((t=>e.removeItem(t).catch((e=>{console.error(`Failed to clean up session ${t}:`,e)}))));await Promise.all(t),this.#y.clear()}}get sessionID(){return this.#f}async load(e){this.#f=e,this.#m=void 0,await this.#A(),await this.#b()}async#A(){if(!VALID_COOKIE_REGEX.test(this.#g))throw new AstroError({...SessionStorageSaveError,message:"Invalid cookie name. Cookie names can only contain letters, numbers, and dashes."});const e=this.#C();this.#l.set(this.#g,e,this.#h)}async#b(){const e=await this.#I();if(this.#m&&!this.#E)return this.#m;this.#m??=new Map;const t=await e.get(this.#C());if(!t)return this.#m;try{const e=unflatten(t);if(!(e instanceof Map))throw await this.#P(),new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message("The session data was an invalid type.",this.#d.driver)});const r=Date.now();for(const[t,s]of e){const e="number"==typeof s.expires&&s.expires<r;this.#m.has(t)||this.#w.has(t)||e||this.#m.set(t,s)}return this.#E=!1,this.#m}catch(e){if(await this.#P(),e instanceof AstroError)throw e;throw new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message("The session data could not be parsed.",this.#d.driver)},{cause:e})}}#P(){this.#f&&this.#y.add(this.#f),this.#g&&this.#l.delete(this.#g,this.#h),this.#f=void 0,this.#m=void 0,this.#v=!0}#C(){return this.#f??=this.#l.get(this.#g)?.value??crypto.randomUUID(),this.#f}async#I(){if(this.#p)return this.#p;if(AstroSession.#S.has(this.#d.driver))return this.#p=AstroSession.#S.get(this.#d.driver),this.#p;if("test"===this.#d.driver)return this.#p=this.#d.options.mockStorage,this.#p;if("fs"!==this.#d.driver&&"fsLite"!==this.#d.driver&&"fs-lite"!==this.#d.driver||(this.#d.options??={},this.#d.driver="fs-lite",this.#d.options.base??=".astro/session"),!this.#d?.driver)throw new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message("No driver was defined in the session configuration and the adapter did not provide a default driver.")});let e=null;const t=await resolveSessionDriver(this.#d.driver);try{this.#d.driverModule?e=(await this.#d.driverModule()).default:t&&(e=(await import(t)).default)}catch(e){if("ERR_MODULE_NOT_FOUND"===e.code)throw new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message(e.message.includes(`Cannot find package '${t}'`)?"The driver module could not be found.":e.message,this.#d.driver)},{cause:e});throw e}if(!e)throw new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message("The module did not export a driver.",this.#d.driver)});try{return this.#p=createStorage({driver:e(this.#d.options)}),AstroSession.#S.set(this.#d.driver,this.#p),this.#p}catch(e){throw new AstroError({...SessionStorageInitError,message:SessionStorageInitError.message("Unknown error",this.#d.driver)},{cause:e})}}}async function resolveSessionDriver(e){if(!e)return null;try{if("fs"===e)return await import.meta.resolve(builtinDrivers.fsLite);if(e in builtinDrivers)return await import.meta.resolve(builtinDrivers[e])}catch{return null}return e}const apiContextRoutesSymbol=Symbol.for("context.routes");class RenderContext{constructor(e,t,r,s,a,n,o,i,c,u=new AstroCookies(n),l=getParams(o,a),d=new URL(n.url),h={},g=void 0,p=(e.manifest.sessionConfig?new AstroSession(u,e.manifest.sessionConfig,e.runtimeMode):void 0)){this.pipeline=e,this.locals=t,this.middleware=r,this.actions=s,this.pathname=a,this.request=n,this.routeData=o,this.status=i,this.clientAddress=c,this.cookies=u,this.params=l,this.url=d,this.props=h,this.partial=g,this.session=p}isRewriting=!1;counter=0;static async create({locals:e={},middleware:t,pathname:r,pipeline:s,request:a,routeData:n,clientAddress:o,status:i=200,props:c,partial:u,actions:l}){const d=await s.getMiddleware(),h=l??await s.getActions();return setOriginPathname(a,r),new RenderContext(s,e,sequence(...s.internalMiddleware,t??d),h,r,a,n,i,o,void 0,void 0,void 0,c,u)}async render(e,t={}){const{cookies:r,middleware:s,pipeline:a}=this,{logger:n,serverLike:o,streaming:i,manifest:c}=a,u=Object.keys(this.props).length>0?this.props:await getProps({mod:e,routeData:this.routeData,routeCache:this.pipeline.routeCache,pathname:this.pathname,logger:n,serverLike:o,base:c.base}),l=this.createActionAPIContext(),d=this.createAPIContext(u,l);if(this.counter++,4===this.counter)return new Response("Loop Detected",{status:508,statusText:"Astro detected a loop where you tried to call the rewriting logic more than four times."});if(isRouteExternalRedirect(this.routeData))return renderRedirect(this);const h=await callMiddleware(s,d,(async(s,o)=>{if(o){const t=this.pathname;a.logger.debug("router","Called rewriting to:",o);const{routeData:r,componentInstance:s,pathname:n,newUrl:i}=await a.tryRewrite(o,this.request);if(!0===this.pipeline.serverLike&&!1===this.routeData.prerender&&!0===r.prerender)throw new AstroError({...ForbiddenRewrite,message:ForbiddenRewrite.message(this.pathname,n,r.component),hint:ForbiddenRewrite.hint(r.component)});this.routeData=r,e=s,o instanceof Request?this.request=o:this.request=copyRequest(i,this.request,r.prerender,this.pipeline.logger,this.routeData.route),this.isRewriting=!0,this.url=new URL(this.request.url),this.cookies=new AstroCookies(this.request),this.params=getParams(r,n),this.pathname=n,this.status=200,setOriginPathname(this.request,t)}let c;if(!s.isPrerendered){const{action:e,setActionResult:t,serializeActionResult:r}=getActionContext(s);if("form"===e?.calledFrom){const s=await e.handler();t(e.name,r(s))}}switch(this.routeData.type){case"endpoint":c=await renderEndpoint(e,s,this.routeData.prerender,n);break;case"redirect":return renderRedirect(this);case"page":{const r=await this.createResult(e,l);try{c=await renderPage(r,e?.default,u,t,i,this.routeData)}catch(e){throw r.cancelled=!0,e}c.headers.set(ROUTE_TYPE_HEADER,"page"),"/404"!==this.routeData.route&&"/500"!==this.routeData.route||c.headers.set(REROUTE_DIRECTIVE_HEADER,"no"),this.isRewriting&&c.headers.set(REWRITE_DIRECTIVE_HEADER_KEY,REWRITE_DIRECTIVE_HEADER_VALUE);break}case"fallback":return new Response(null,{status:500,headers:{[ROUTE_TYPE_HEADER]:"fallback"}})}const d=getCookiesFromResponse(c);return d&&r.merge(d),c}));return h.headers.get(ROUTE_TYPE_HEADER)&&h.headers.delete(ROUTE_TYPE_HEADER),attachCookiesToResponse(h,r),h}createAPIContext(e,t){return Reflect.set(t,apiContextRoutesSymbol,this.pipeline),Object.assign(t,{props:e,redirect:(e,t=302)=>new Response(null,{status:t,headers:{Location:e}}),getActionResult:createGetActionResult(t.locals),callAction:createCallAction(t)})}async#D(e){this.pipeline.logger.debug("router","Calling rewrite: ",e);const t=this.pathname,{routeData:r,componentInstance:s,newUrl:a,pathname:n}=await this.pipeline.tryRewrite(e,this.request);if(this.pipeline.serverLike&&!this.routeData.prerender&&r.prerender)throw new AstroError({...ForbiddenRewrite,message:ForbiddenRewrite.message(this.pathname,n,r.component),hint:ForbiddenRewrite.hint(r.component)});return this.routeData=r,e instanceof Request?this.request=e:this.request=copyRequest(a,this.request,r.prerender,this.pipeline.logger,this.routeData.route),this.url=new URL(this.request.url),this.cookies=new AstroCookies(this.request),this.params=getParams(r,n),this.pathname=n,this.isRewriting=!0,this.status=200,setOriginPathname(this.request,t),await this.render(s)}createActionAPIContext(){const e=this,{cookies:t,params:r,pipeline:s,url:a}=this,n=`Astro v${ASTRO_VERSION}`;return{cookies:t,routePattern:this.routeData.route,isPrerendered:this.routeData.prerender,get clientAddress(){return e.getClientAddress()},get currentLocale(){return e.computeCurrentLocale()},generator:n,get locals(){return e.locals},set locals(e){throw new AstroError(LocalsReassigned)},params:r,get preferredLocale(){return e.computePreferredLocale()},get preferredLocaleList(){return e.computePreferredLocaleList()},rewrite:async e=>await this.#D(e),request:this.request,site:s.site,url:a,get originPathname(){return getOriginPathname(e.request)},get session(){if(this.isPrerendered)s.logger.warn("session",`context.session was used when rendering the route ${green(this.routePattern)}, but it is not available on prerendered routes. If you need access to sessions, make sure that the route is server-rendered using \`export const prerender = false;\` or by setting \`output\` to \`"server"\` in your Astro config to make all your routes server-rendered by default. For more information, see https://docs.astro.build/en/guides/sessions/`);else{if(e.session)return e.session;s.logger.warn("session",`context.session was used when rendering the route ${green(this.routePattern)}, but no storage configuration was provided. Either configure the storage manually or use an adapter that provides session storage. For more information, see https://docs.astro.build/en/guides/sessions/`)}}}}async createResult(e,t){const{cookies:r,pathname:s,pipeline:a,routeData:n,status:o}=this,{clientDirectives:i,inlinedScripts:c,compressHTML:u,manifest:l,renderers:d,resolve:h}=a,{links:g,scripts:p,styles:m}=await a.headElements(n),f=await a.componentMetadata(n)??l.componentMetadata,y=new Headers({"Content-Type":"text/html"}),w="boolean"==typeof this.partial?this.partial:Boolean(e.partial),v=hasActionPayload(this.locals)?deserializeActionResult(this.locals._actionPayload.actionResult):void 0,R={status:v?.error?v?.error.status:o,statusText:v?.error?v?.error.type:"OK",get headers(){return y},set headers(e){throw new AstroError(AstroResponseHeadersReassigned)}},E={base:l.base,userAssetsBase:l.userAssetsBase,cancelled:!1,clientDirectives:i,inlinedScripts:c,componentMetadata:f,compressHTML:u,cookies:r,createAstro:(e,r,s)=>this.createAstro(E,e,r,s,t),links:g,params:this.params,partial:w,pathname:s,renderers:d,resolve:h,response:R,request:this.request,scripts:p,styles:m,actionResult:v,serverIslandNameMap:l.serverIslandNameMap??new Map,key:l.key,trailingSlash:l.trailingSlash,_metadata:{hasHydrationScript:!1,rendererSpecificHydrationScripts:new Set,hasRenderedHead:!1,renderedScripts:new Set,hasDirectives:new Set,hasRenderedServerIslandRuntime:!1,headInTree:!1,extraHead:[],propagators:new Set}};return E}#k;createAstro(e,t,r,s,a){let n;n=this.isRewriting?this.#k=this.createAstroPagePartial(e,t,a):this.#k??=this.createAstroPagePartial(e,t,a);const o={props:r,self:null},i=Object.assign(Object.create(n),o);let c;return Object.defineProperty(i,"slots",{get:()=>(c||(c=new Slots(e,s,this.pipeline.logger)),c)}),i}createAstroPagePartial(e,t,r){const s=this,{cookies:a,locals:n,params:o,pipeline:i,url:c}=this,{response:u}=e,l=createCallAction(r);return{generator:t.generator,glob:t.glob,routePattern:this.routeData.route,isPrerendered:this.routeData.prerender,cookies:a,get session(){if(this.isPrerendered)i.logger.warn("session",`Astro.session was used when rendering the route ${green(this.routePattern)}, but it is not available on prerendered pages. If you need access to sessions, make sure that the page is server-rendered using \`export const prerender = false;\` or by setting \`output\` to \`"server"\` in your Astro config to make all your pages server-rendered by default. For more information, see https://docs.astro.build/en/guides/sessions/`);else{if(s.session)return s.session;i.logger.warn("session",`Astro.session was used when rendering the route ${green(this.routePattern)}, but no storage configuration was provided. Either configure the storage manually or use an adapter that provides session storage. For more information, see https://docs.astro.build/en/guides/sessions/`)}},get clientAddress(){return s.getClientAddress()},get currentLocale(){return s.computeCurrentLocale()},params:o,get preferredLocale(){return s.computePreferredLocale()},get preferredLocaleList(){return s.computePreferredLocaleList()},locals:n,redirect:(e,t=302)=>{if(this.request[responseSentSymbol$1])throw new AstroError({...ResponseSentError});return new Response(null,{status:t,headers:{Location:e}})},rewrite:async e=>await this.#D(e),request:this.request,response:u,site:i.site,getActionResult:createGetActionResult(n),get callAction(){return l},url:c,get originPathname(){return getOriginPathname(s.request)}}}getClientAddress(){const{pipeline:e,request:t,routeData:r,clientAddress:s}=this;if(r.prerender)throw new AstroError({...PrerenderClientAddressNotAvailable,message:PrerenderClientAddressNotAvailable.message(r.component)});if(s)return s;if(clientAddressSymbol in t)return Reflect.get(t,clientAddressSymbol);if(e.adapterName)throw new AstroError({...ClientAddressNotAvailable,message:ClientAddressNotAvailable.message(e.adapterName)});throw new AstroError(StaticClientAddressNotAvailable)}#O;computeCurrentLocale(){const{url:e,pipeline:{i18n:t},routeData:r}=this;if(!t)return;const{defaultLocale:s,locales:a,strategy:n}=t,o="pathname-prefix-other-locales"===n||"domains-prefix-other-locales"===n?s:void 0;if(this.#O)return this.#O;let i;if(isRouteServerIsland(r)){let e=this.request.headers.get("referer");e&&(URL.canParse(e)&&(e=new URL(e).pathname),i=computeCurrentLocale(e,a,s))}else{let t=r.pathname;if(!r.pattern.test(e.pathname))for(const s of r.fallbackRoutes)if(s.pattern.test(e.pathname)){t=s.pathname;break}t=t&&!isRoute404or500(r)?t:e.pathname,i=computeCurrentLocale(t,a,s)}return this.#O=i??o,this.#O}#T;computePreferredLocale(){const{pipeline:{i18n:e},request:t}=this;if(e)return this.#T??=computePreferredLocale(t,e.locales)}#_;computePreferredLocaleList(){const{pipeline:{i18n:e},request:t}=this;if(e)return this.#_??=computePreferredLocaleList(t,e.locales)}}function sequence(...e){const t=e.filter((e=>!!e)),r=t.length;return defineMiddleware(r?(e,s)=>{let a;return function e(n,o){const i=(0,t[n])(o,(async t=>{if(n<r-1){if(t){let e;e=t instanceof Request?t:t instanceof URL?new Request(t,o.request):new Request(new URL(t,o.url.origin),o.request);const r=o.url.pathname,s=Reflect.get(o,apiContextRoutesSymbol),{routeData:n,pathname:i}=await s.tryRewrite(t,o.request);if(!0===s.serverLike&&!1===o.isPrerendered&&!0===n.prerender)throw new AstroError({...ForbiddenRewrite,message:ForbiddenRewrite.message(o.url.pathname,i,n.component),hint:ForbiddenRewrite.hint(n.component)});a=t,o.request=e,o.url=new URL(e.url),o.cookies=new AstroCookies(e),o.params=getParams(n,i),setOriginPathname(o.request,r)}return e(n+1,o)}return s(t??a)}));return i}(0,e)}:(e,t)=>t())}function defineMiddleware(e){return e}export{PERSIST_SYMBOL as P,RouteCache as R,SERVER_ISLAND_COMPONENT as S,SERVER_ISLAND_ROUTE as a,RenderContext as b,createEndpoint as c,defineMiddleware as d,findRouteToRewrite as f,getSetCookiesFromResponse as g,isRequestServerIsland as i,matchRoute as m,requestIs404Or500 as r,sequence as s};